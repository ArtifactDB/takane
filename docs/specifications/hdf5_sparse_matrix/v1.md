# HDF5 sparse matrix

## Overview

A compressed sparse matrix stored inside a HDF5 file, corresponding to the [`hdf5_sparse_matrix`](https://github.com/ArtifactDB/BiocObjectSchemas/raw/master/raw/hdf5_sparse_matrix/v1.json) schema.
We use `~` below to denote properties of the schema.

The HDF5 group (specified by `~hdf5_sparse_matrix.group`) should contain the typical contents of the compressed sparse matrix, i.e., `indices`, `indptr` and `data`.
`data` should be a 1-dimensional integer or floating-point dataset containing the values of the non-zero elements;
`indices` should be a 1-dimensional integer dataset containing the 0-based row/column index for each non-zero element in `data`;
and `indptr` should be a 1-dimensional integer dataset of length equal to the number of columns/rows plus 1, containing pointers to the start and end of each column/row.

If `~hdf5_sparse_matrix.format` is equal to `"tenx_matrix"`, `indices` should contain row indices and `indptr` should contain the column index pointers. 
The group should also contain a `shape` dataset, an 1-dimensional integer dataset of length 2 storing the number of rows and columns - this should be equal to `array.dimensions`.
  - **For `~hdf5_sparse_matrix.version >= 3`:** the `shape` datatype should be a subset of a 64-bit signed integer.

**For `~hdf5_sparse_matrix.version >= 3`:** 
the HDF5 datatype of `indices` and `indptr` should be a subset of a 64-bit unsigned integer.

The type of the matrix is specified by `~array.type` and should be integer, boolean or numeric.
This determines the appropriate HDF5 datatype for `data`.
The exact type is generally left to the discretion of the data generator, with some restrictions:

- A number matrix should be represented by any integer or floating-point `data`.
  - **For `~hdf5_sparse_matrix.version >= 3`:** the HDF5 datatype should be a subset of a 64-bit float.
    See the [HDF5 policy draft (0.1.0)](https://github.com/ArtifactDB/Bioc-HDF5-policy/tree/0.1.0) for more details.
- An integer matrix should be represented by an integer `data`.
  - **For `~hdf5_sparse_matrix.version >= 3`:** the datatype should be a subset of a 32-bit signed integer.
- A booleanm matrix can be represented by an integer `data`, where a value of 1 is truthy and a value of zero is falsey.
  - **For `~hdf5_sparse_matrix.version >= 3`:** the datatype should be a subset of a 32-bit signed integer.

## Missing values

The treatment of missing values is version-dependent:

- **For `~hdf5_sparse_matrix.version >= 3`:** 
  the `data` dataset may have a `missing-value-placeholder` attribute, containing a scalar value to use as a missing value placeholder.
  Any value equal to this placeholder should be treated as missing.
  The HDF5 datatype of the attribute should be exactly equal to that of the dataset.
  For number matrices, the scalar value may be NaN, in which case all NaNs in the dataset are treated as missing regardless of the payload.
  If no attribute exists, it can be assumed that no values are missing.
  See the [HDF5 policy draft (0.1.0)](https://github.com/ArtifactDB/Bioc-HDF5-policy/tree/0.1.0) for more details.
- **For `~hdf5_dense_matrix.version = 2`:** 
  the `data` dataset may have a `missing-value-placeholder` attribute, containing a scalar value to use as a missing value placeholder.
  Any value equal to this placeholder should be treated as missing.
  The HDF5 datatype of the attribute should be exactly equal to that of the dataset.
  For numbers, the scalar value may be NaN with a non-default payload, which should be considered via byte-wise comparisons, e.g., with `memcmp`.
  If no attribute exists, it can be assumed that no values are missing.
- **For `~hdf5_sparse_matrix.version = 1`:** 
  Missing integers and booleans are represented by -2147483648.
  Missing numbers are represented by a quiet NaN with a payload of 1954.

## Dimension names

Dimnames may also be saved inside the same HDF5 file, as string datasets in another group.
In such cases, the `~hdf5_sparse_matrix.dimnames` property should be present and contain the name of that group.
This group should contain zero or one string datasets for each dimension. 
The name of each string dataset is based on its dimension - `"0"` for rows, `"1"` for columns - and should have length equal to the extent of that dimension.
If no dataset is not present for a dimension, it can be assumed that no dimnames are available for that dimension

## Example usage

```cpp
#include "takane/takane.hpp"

takane::hdf5_sparse_matrix::Parameters params(group_name, { 10, 20 });
params.type = takane::array::Type::BOOLEAN;

takane::hdf5_sparse_matrix::validate(file_path, params);
```
